<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Sterreborne scheduler</title>
</head>

<body> 
  <style>
  p,span,form {font-family:Arial, sans-serif;font-size:14px;}
  span.userinfo { font-style: italic; color: black; }
  span.redstatus {font-weight: 900;color: rgb(255,0,0); background-color: white}
  span.bluestatus {font-weight: 900;color: rgb(0,0,255);}

  button.redbutton {font-weight: 900;color: rgb(255,0,0); background-color: white; border:none}
  button.bluebutton {font-weight: 900;color: rgb(0,0,255); background-color: white; border:none}
  button.unknownbutton {font-weight: 900;color: lightgrey; background-color: white; border:none}

  div.fixed {
    position: fixed;
    top: 0;
    left: 20px;
  }
  </style>

<style type="text/css">
.tg  {border-collapse:collapse;border-spacing:0;}
.tg td{font-family:Arial, sans-serif;font-size:14px;padding:10px 5px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;}
.tg .white{vertical-align:top}
.tg .blue{background-color:#33fcff;vertical-align:top}
.tg .darkblue{background-color:#0004ff;vertical-align:top}
.tg .red{background-color:#ffccc9;vertical-align:top}
.tg .darkred{background-color:#ff0000;vertical-align:top}
</style>



<script src="https://code.jquery.com/jquery-1.10.2.js"></script>

<style type="text/css">
.legend  {border-collapse:collapse;border-spacing:0;}
.legend   td{font-family:Arial, sans-serif;font-size:14px;padding:5px 5px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;}
.legend   .white{vertical-align:top; border-style:none; padding-right:30px}
.legend   .blue{background-color:#33fcff;vertical-align:top;     width:30px}
.legend   .darkblue{background-color:#0004ff;vertical-align:top; width:30px}
.legend   .red{background-color:#ffccc9;vertical-align:top;      width:30px}
.legend   .darkred{background-color:#ff0000;vertical-align:top;  width:30px}
</style>

        <style type="text/css">
            * {font-family:Arial, sans-serif;font-size:12px}
            input.white {background-color:white}
            input.green {background-color:green}
            input.grey {background-color:grey}
            input.red {background-color:red}
        </style>



<div class="fixed">
   <br>
        <form>
            <input type="text" id="serverAddress" name="serverAddress" class="white" value="ws://X.X.X.X:2603">
        </form>
        <br>
<table>
<tr>
<td>
   <form id="targetform">
     <select name="target" id="targetselect" onchange="change_target()" >
       <option value="heating">Heating</option>
       <option value="boiler">Boiler</option>
     </select>
   </form>
</td>
<td>
   <form id="statusform">
   <button type="button" id="statusbutton" class="unknownbutton">STATUS ?</button>
   <span id="statusinfo" class="userinfo"></span>
   </form>
</td>
</tr>
</table>
<br>

   <table class="legend" id="legend">
   <tbody>
   <tr> 
   <td class="white" style="padding-left:0px;padding-right:30px">SELECT A COLOR :  </td>
   <td class="red"       onmousedown='setActiveColor("red")'>  </td> 
   <td class="white"     onmousedown='setActiveColor("red")'> ON, every week </td> 
   <td class="blue"      onmousedown='setActiveColor("blue")'>  </td> 
   <td class="white"     onmousedown='setActiveColor("blue")'> OFF, every week </td> 
   <td class="darkred"   onmousedown='setActiveColor("darkred")'>  </td> 
   <td class="white"     onmousedown='setActiveColor("darkred")'> ON, once </td> 
   <td class="darkblue"  onmousedown='setActiveColor("darkblue")'>  </td> 
   <td class="white"     onmousedown='setActiveColor("darkblue")'> OFF, once </td> 
   </tr>
   </tbody>
   </table>
   <br>

   <form>
   <button type="button" id="commitbutton" >COMMIT</button>
   <span id="commitinfo" class="userinfo"> ( no changes since schedule loaded )</span>
   </form>
   <br>
   <br>
</div>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<br>
<span id="logoutput">
</span>
<span id="table">
</span>
<br>


<script> 

// global variables

        g_firstCell=null;       // first corner of the area the user wants to change
        g_activeColor="red";    // color selected in the legend

        g_cells = new Array(96);    // stores a pointer to all the td in the schedule
        for (var i = 0; i < 24*4; i++) {
         g_cells[i] = new Array(7);
        }

        g_colors = new Array(96);    // stores the colors until the second point of the area is clicked
        for (var i = 0; i < 24*4; i++) {
         g_colors[i] = new Array(7);
        }

        g_initialcolors = new Array(96); // stores the colors on table load to know how many cells have changed
        for (var i = 0; i < 24*4; i++) {
         g_initialcolors[i] = new Array(7);
        }

        var g_dayToRow = {};


            // figure out ip address or host name of the RGPIO server to construct WebSocket server URL

            g_ws = null;
            g_serverAddress = "ws://192.168.0.3:7789";
            document.getElementById("serverAddress").value = g_serverAddress;

            function wsconnect() {

                if ("WebSocket" in window)
                {
                    var serverAddress = document.getElementById('serverAddress').value;
                    g_ws = new WebSocket(serverAddress);

                    g_ws.onopen = function ()
                    {
                        document.getElementById("serverAddress").className = "green";
                        onWSConnected();  // are all functions already loaded now??
                    };

                    g_ws.onclose = function (evt)
                    {
                        document.getElementById("serverAddress").className = "red";
                    };

                    g_ws.onerror = function ()
                    {
                        document.getElementById("serverAddress").className = "red";
                    };

                    g_ws.onmessage = function (event)
                    {
                        try {
                                    var msg = JSON.parse(event.data);
                            } catch (e) {
                                    console.log("JSON.parse failed on : " + event.data);

                            }
                        if (typeof msg !== "undefined") {
                          if (msg.messageID === "STATUS") {
                           g_statusButton.innerHTML="STATUS : "+msg.status; 
                           if (msg.status==="ON")  setStatusColor("redbutton");
                           if (msg.status==="OFF") setStatusColor("bluebutton");
                          } else if (msg.messageID === "CS") {    // current schedule
console.log(event.data);
                           var day=msg.day;
                           var hour=msg.hour;
                           var minute=msg.minute;
                           var color=msg.color;
                           var row=g_dayToRow[day];
                           var col=4*hour;
                           if (minute==="15") col=col+1;
                           if (minute==="30") col=col+2;
                           if (minute==="45") col=col+3;
                           var td= g_cells[col][row];
console.log("td row="+row+" col="+col+" name="+td.innerHTML);
                           td.className=color;
                          }
                        }
                           
                   }
            }
}


wsconnect();

function setStatusColor(color){
g_statusButton.className=color;
}

g_statusButton= document.getElementById("statusbutton");

function updateStatus(){
             g_statusButton.innerHTML="STATUS : waiting for response..."; 
             setStatusColor("unknownbutton");
             g_ws.send("GETSTATUS");
};

g_statusButton.onclick="updateStatus()";

function change_target(){
 console.log($("#targetselect").val());
 if ($("#targetselect").val() == "heating") { g_port=6789; };
 if ($("#targetselect").val() == "boiler") { g_port=6790; };
 load_schedule();
 console.log("server port = "+g_port);
};

$("#targetform").submit(
function(event){
 console.log($("#targetselect").val());
 if ($("#targetselect").val() == "heating") { g_port=6789; };
 if ($("#targetselect").val() == "boiler") { g_port=6790; };
 load_schedule();
 console.log("server port = "+g_port);
 event.preventDefault();
});

</script>


<script> 

$(document).keydown(        //    intercept <ESC>
function keydown(event) {
 if (event.which == 27) {
 g_firstCell=null;
 restoreColors();
 }
});


function doDown(element) {  // called when schedule cell is clicked
if (g_firstCell==null) { // first corner was clicked
  g_firstCell=element;

//console.log("first cell = "+element.innerHTML);
//console.log("saving current cell colors.);

  var x;
  var y;
  for (y = 0; y < 7;  y++) {
      for (x = 0; x < 24*4; x++) {
          g_colors[x][y]=g_cells[x][y].className;
      }
  }

} else {  // second corner cell was clicked

  //console.log("second cell = "+element.innerHTML);
  //convert first and second corner to x,y coordinates
  
  var xy=g_firstCell.id;
  var axy=xy.split(":");
  var x1=Number(axy[0]);
  var y1=Number(axy[1]);
  var xy=element.id;
  var axy=xy.split(":");
  var x2=Number(axy[0]);
  var y2=Number(axy[1]);
  var xmin=Math.min(x1,x2);
  var xmax=Math.max(x1,x2);
  var ymin=Math.min(y1,y2);
  var ymax=Math.max(y1,y2);

  //console.log("area ("+xmin+","+ymin+") ("+xmax+","+ymax+")");

  // set all cells in this area to the selected color

  var x;
  var y;
  for (y = 0; y < 7;  y++) {
      for (x = 0; x < 24*4; x++) {
          if ((x>=xmin) && (x<=xmax) && (y>=ymin) && (y<=ymax)) {
             g_cells[x][y].className=g_activeColor;
          }
      }
  }

  // compare to the initial colors and count the number of cells that changed

  var changedcells=0;
  for (y = 0; y < 7;  y++) {
      for (x = 0; x < 24*4; x++) {
          if (g_cells[x][y].className != g_initialcolors[x][y]){changedcells++};
      }
  }
  $("#commitinfo").text(" ( "+changedcells+" cells changed )");

g_firstCell=null;
}
};

function doEnter(element) {  // called when mouse moves into a schedule cell
if (g_firstCell!=null) { // hovering into a cell after first corner was clicked

  restoreColors();

  // find coordinates of the area

  var xy=g_firstCell.id;
  var axy=xy.split(":");
  var x1=Number(axy[0]);
  var y1=Number(axy[1]);
  var xy=element.id;
  var axy=xy.split(":");
  var x2=Number(axy[0]);
  var y2=Number(axy[1]);
  var xmin=Math.min(x1,x2);
  var xmax=Math.max(x1,x2);
  var ymin=Math.min(y1,y2);
  var ymax=Math.max(y1,y2);
  
  //console.log("area ("+xmin+","+ymin+") ("+xmax+","+ymax+")");

  // set all cells in the area to the selected color

  var x;
  var y;
  for (y = 0; y < 7;  y++) {
      for (x = 0; x < 24*4; x++) {
          if ((x>=xmin) && (x<=xmax) && (y>=ymin) && (y<=ymax)) {
             g_cells[x][y].className=g_activeColor;
          }
      }
  }
  

}
};

function restoreColors(){
  //console.log("restoring table colors");

  var x;
  var y;
  for (y = 0; y < 7;  y++) {
      for (x = 0; x < 24*4; x++) {
          g_cells[x][y].className=g_colors[x][y];
      }
  }

};

function setActiveColor(colorName) {
g_activeColor=colorName;
};

function onWSConnected() {
  g_port=6789;
  constructTable();
  create_g_cells();
  load_schedule();

var days = ["SUNDAY","MONDAY","TUESDAY","WEDNESDAY","THURSDAY","FRIDAY","SATURDAY"];
var k;
for (k = 0; k < days.length; k++) {
 console.log("col for day "+days[k]+" is "+ g_dayToRow[days[k]]);
}

}


function load_schedule(){
        updateStatus();
        g_ws.send("GETSCHEDULE");
};

function create_g_cells(){
  // create a 2D array with the table cells.
  // This to avoid navigating the DOM each time to perform an action on all the cells

  var table=document.getElementById("schedule");
  var tablebody = table.getElementsByTagName('TBODY')[0];
  var tablerows=tablebody.getElementsByTagName('TR');
  var y;
  for (y = 0; y < tablerows.length; y++) {
      var rowentries=tablerows[y].getElementsByTagName('TD');
      var x;
      for (x = 0; x < (rowentries.length-1); x++) {
          var td=rowentries[x+1];
          g_cells[x][y]=td;
          g_initialcolors[x][y]=td.className;
      }
  }
};


$("#commitbutton").click(
function(){

  var table=document.getElementById("schedule");
  var tablebody = table.getElementsByTagName('TBODY')[0];
  var tablerows=tablebody.getElementsByTagName('TR');
  var i;
  for (i = 0; i < tablerows.length; i++) {
      var rowentries=tablerows[i].getElementsByTagName('TD');
      var rowhead=rowentries[0];
      var day=rowhead.innerHTML;
      var e;
      for (e = 1; e < rowentries.length; e++) {
          var td=rowentries[e];
          g_ws.send("NS:"+day+':'+td.innerHTML+":"+td.className);
      }
  }
  g_ws.send("NS:APPLY");

 create_g_cells();  // just to reset g_initialcolors

 setTimeout(        // allow the server some time to process the new schedule
   function commitEffect() {
      updateStatus();
      $("#commitinfo").text("no changes since last commit");
   },
   3000);

}
);


function constructTable(){

var d = new Date();
var days = ["SUNDAY","MONDAY","TUESDAY","WEDNESDAY","THURSDAY","FRIDAY","SATURDAY"];
var k; 
for (k = 0; k < days.length; k++) {
 console.log("today+"+k+" is "+ days[(d.getDay()+k)%7]);
}

    var table = document.createElement('table');
    table.id="schedule";
    table.className="tg";
    var tablebody = document.createElement('tbody');
    table.appendChild(tablebody);
    var i;
    for (i = 0; i < days.length; i++) {
        var tr = document.createElement('tr');   
        var rowDay=days[(d.getDay()+i)%7];
        g_dayToRow[rowDay]=i;

        tr.id=rowDay;
    
        var td1 = document.createElement('td');
        td1.innerHTML=rowDay;
        td1.className="white";
        tr.appendChild(td1);
    
        var quarters = ["00","15","30","45"];
        var h,q,id;
        id=0;
        for (h = 0; h < 24; h++) {
         for (q = 0; q < quarters.length; q++) {
           var td2 = document.createElement('td');
    //    <td id="0:0" class="blue" onmousedown="doDown(this)"  onmouseenter="doEnter(this)" >0:00</td>
           td2.id=id+":"+i;
           id++;
           td2.innerHTML=h+":"+quarters[q];
           td2.className="blue";
           td2.setAttribute("onmousedown","doDown(this)");
           td2.setAttribute("onmouseenter","doEnter(this)");
           tr.appendChild(td2);
         }
        }
    
        tablebody.appendChild(tr);
    }
    document.getElementById("table").appendChild(table);
  var tablebody = table.getElementsByTagName('TBODY');
console.log('table body = '+tablebody.length);

}


</script>


        <script>


        </script>

    </body>
</html>

